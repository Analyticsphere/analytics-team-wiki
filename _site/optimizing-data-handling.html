<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jake Peters">
<meta name="author" content="Rebecca Sansale">

<title>c4cp Analytics Team Wiki - Optimizing Data Handling with R and BigQuery</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">c4cp Analytics Team Wiki</span>
    </a>
  </div>
        <div class="quarto-navbar-tools ms-auto tools-wide">
    <a href="" rel="" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-youtube"></i></a>
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label=""><i class="bi bi-box"></i></a>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item quarto-navbar-tools ms-auto-item" href="https://nih.app.box.com/folder/136319755809">
            QC Reports
            </a>
          </li>
      </ul>
    </div>
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-1" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label=""><i class="bi bi-cloud"></i></a>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="quarto-navigation-tool-dropdown-1">
          <li>
            <a class="dropdown-item quarto-navbar-tools ms-auto-item" href="https://console.cloud.google.com/bigquery?project=nih-nci-dceg-connect-dev">
            dev
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools ms-auto-item" href="https://console.cloud.google.com/bigquery?project=nih-nci-dceg-connect-stg-5519">
            stg
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools ms-auto-item" href="https://console.cloud.google.com/bigquery?project=nih-nci-dceg-connect-prod-6d04">
            prod
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools ms-auto-item" href="">
            bq2-dev
            </a>
          </li>
      </ul>
    </div>
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-2" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label=""><i class="bi bi-github"></i></a>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="quarto-navigation-tool-dropdown-2">
          <li>
            <a class="dropdown-item quarto-navbar-tools ms-auto-item" href="https://github.com/analyticsphere">
            Analyticsphere
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools ms-auto-item" href="https://github.com/Analyticsphere/qaqc_testing">
            Analyticsphere/qaqc_testing
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools ms-auto-item" href="https://github.com/Analyticsphere/flatteningRequests">
            Analyticsphere/flatteningRequest
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools ms-auto-item" href="https://github.com/Analyticsphere/ConnectMasterAndSurveyCombinedDataDictionary">
            Analyticsphere/ConnectMasterAndSurveyCombinedDataDictionary
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools ms-auto-item" href="https://github.com/Analyticsphere/ccc_module_metrics_gcp_pipeline">
            Analyticsphere/ccc_module_metrics_gcp_pipeline
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools ms-auto-item" href="https://github.com/Analyticsphere/ccc_biospecimen_metrics_gcp_pipeline">
            Analyticsphere/ccc_biospecimen_metrics_gcp_pipeline
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools ms-auto-item" href="https://github.com/Analyticsphere/weekly_ccc_report_gcp_pipeline">
            Analyticsphere/weekly_ccc_report_gcp_pipeline
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools ms-auto-item" href="https://github.com/Analyticsphere/CIDTool">
            Analyticsphere/CIDTool
            </a>
          </li>
      </ul>
    </div>
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./contributing-to-github.html">Tutorials</a></li><li class="breadcrumb-item"><a href="./optimizing-data-handling.html">Optimizing Data Handling with R and BigQuery</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./team-roles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Team Roles</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Documentation</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./bigquery-data-tables.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">BigQuery Data Tables</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./flattening.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Flattening</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./qaqc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">QAQC</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./reporting-pipelines.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Reporting Pipelines</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./gcp-box-connection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">GCP to Box Connection</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./survey-metrics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Survey Metrics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./biospecimen-metrics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Biospecimen Metrics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./stakeholder-metrics-dashboard.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Stakeholder Metrics Dashboard</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Tutorials</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./contributing-to-github.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">GitHub Contributions Tutorial</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./optimizing-data-handling.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Optimizing Data Handling with R and BigQuery</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./style-guide.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Style Guide</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Training</span></span>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">SOPs</span></span>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Covering for PTO</span></span>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#simple-rules-for-optimization" id="toc-simple-rules-for-optimization" class="nav-link active" data-scroll-target="#simple-rules-for-optimization">Simple Rules for Optimization</a></li>
  <li><a href="#methods-for-downloadingmanipulating-bq-data" id="toc-methods-for-downloadingmanipulating-bq-data" class="nav-link" data-scroll-target="#methods-for-downloadingmanipulating-bq-data">4 Methods for Downloading/Manipulating BQ data</a>
  <ul class="collapse">
  <li><a href="#about-the-example-data-and-analysis" id="toc-about-the-example-data-and-analysis" class="nav-link" data-scroll-target="#about-the-example-data-and-analysis">About the Example Data and Analysis</a></li>
  <li><a href="#transformations-across-all-methods" id="toc-transformations-across-all-methods" class="nav-link" data-scroll-target="#transformations-across-all-methods">Transformations Across All Methods</a></li>
  </ul></li>
  <li><a href="#methods-of-loading-and-processing-data-from-bigquery-in-r" id="toc-methods-of-loading-and-processing-data-from-bigquery-in-r" class="nav-link" data-scroll-target="#methods-of-loading-and-processing-data-from-bigquery-in-r">4 Methods of Loading and Processing Data from BigQuery in R</a>
  <ul class="collapse">
  <li><a href="#load-dependencies-parameterize" id="toc-load-dependencies-parameterize" class="nav-link" data-scroll-target="#load-dependencies-parameterize">Load dependencies &amp; parameterize</a></li>
  <li><a href="#method-1-using-bq_table_download" id="toc-method-1-using-bq_table_download" class="nav-link" data-scroll-target="#method-1-using-bq_table_download"><strong>Method 1</strong>: Using bq_table_download</a></li>
  <li><a href="#method-2-process-with-sql-in-bigquery" id="toc-method-2-process-with-sql-in-bigquery" class="nav-link" data-scroll-target="#method-2-process-with-sql-in-bigquery"><strong>Method 2</strong>: Process with SQL in BigQuery</a></li>
  <li><a href="#method-3-using-dbconnect-and-dbplyr" id="toc-method-3-using-dbconnect-and-dbplyr" class="nav-link" data-scroll-target="#method-3-using-dbconnect-and-dbplyr"><strong>Method 3</strong>: Using dbConnect and dbplyr</a></li>
  <li><a href="#method-4-using-materialized-view-in-bigquery" id="toc-method-4-using-materialized-view-in-bigquery" class="nav-link" data-scroll-target="#method-4-using-materialized-view-in-bigquery"><strong>Method 4</strong>: Using “Materialized View” in BigQuery</a></li>
  </ul></li>
  <li><a href="#verification" id="toc-verification" class="nav-link" data-scroll-target="#verification">Verification</a></li>
  <li><a href="#benchmarking" id="toc-benchmarking" class="nav-link" data-scroll-target="#benchmarking">Benchmarking</a></li>
  <li><a href="#conclusions" id="toc-conclusions" class="nav-link" data-scroll-target="#conclusions">Conclusions</a></li>
  <li><a href="#references-and-helpful-links" id="toc-references-and-helpful-links" class="nav-link" data-scroll-target="#references-and-helpful-links">References and Helpful Links</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Optimizing Data Handling with R and BigQuery</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Authors</div>
    <div class="quarto-title-meta-contents">
             <p>Jake Peters </p>
             <p>Rebecca Sansale </p>
          </div>
  </div>
    
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">October 6, 2023</p>
    </div>
  </div>
    
  </div>
  

</header>

<p>As our dataset continues to grow, optimizing data handling becomes paramount for computational efficiency and memory usage. This tutorial explores four methods to achieve these goals, focusing on offloading computation to BigQuery through SQL queries. By following simple rules, such as being selective about data loading and leveraging Materialized Views, you can streamline your data workflows and make them more efficient.</p>
<section id="simple-rules-for-optimization" class="level2">
<h2 class="anchored" data-anchor-id="simple-rules-for-optimization">Simple Rules for Optimization</h2>
<p>To ensure efficient data handling, let’s agree on some simple rules:</p>
<ol type="1">
<li><p><strong>Be Selective</strong>: Load only the variables you need.</p></li>
<li><p><strong>Leverage BigQuery</strong>: Perform filters, joins, and manipulations in BigQuery using SQL or dbConnect/dbplyr.</p></li>
<li><p><strong>Use Views</strong>: Consider creating Materialized Views in BigQuery for repetitive operations.</p></li>
</ol>
</section>
<section id="methods-for-downloadingmanipulating-bq-data" class="level2">
<h2 class="anchored" data-anchor-id="methods-for-downloadingmanipulating-bq-data">4 Methods for Downloading/Manipulating BQ data</h2>
<section id="about-the-example-data-and-analysis" class="level3">
<h3 class="anchored" data-anchor-id="about-the-example-data-and-analysis">About the Example Data and Analysis</h3>
<p>In this tutorial, we work with the “bigquery-public-data.samples.natality” dataset, containing information related to births, including details about newborns like gender, birth weight, and data source.</p>
</section>
<section id="transformations-across-all-methods" class="level3">
<h3 class="anchored" data-anchor-id="transformations-across-all-methods">Transformations Across All Methods</h3>
<p>Common transformations are performed in each method:</p>
<ol type="1">
<li><p><strong>Filtering for Male Newborns</strong>: Include only records for male newborns (is_male == 1).</p></li>
<li><p><strong>Inner Join with Itself</strong>: Perform an inner join with the same dataset based on the “source” column, duplicating the dataset.</p></li>
<li><p><strong>Weight Conversion</strong>: Calculate birth weight in kilograms (birth_weight_kg) by converting pounds to kilograms (0.453592).</p></li>
</ol>
</section>
</section>
<section id="methods-of-loading-and-processing-data-from-bigquery-in-r" class="level2">
<h2 class="anchored" data-anchor-id="methods-of-loading-and-processing-data-from-bigquery-in-r">4 Methods of Loading and Processing Data from BigQuery in R</h2>
<p>This tutorial explores four distinct methods for efficiently loading and processing data from BigQuery in the R programming language. Handling large datasets and performing data transformations is a fundamental aspect of data science and analytics. As data scientists and engineers, it’s crucial to adopt practices that optimize computational efficiency, memory usage, and maintainability in our data workflows.</p>
<p>In this tutorial, we delve into four distinct approaches, each with its own set of advantages and considerations.</p>
<section id="load-dependencies-parameterize" class="level3">
<h3 class="anchored" data-anchor-id="load-dependencies-parameterize">Load dependencies &amp; parameterize</h3>
<div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bigrquery)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DBI)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dbplyr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Define project, dataset, and table IDs</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>project_id <span class="ot">&lt;-</span> <span class="st">"bigquery-public-data"</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>dataset    <span class="ot">&lt;-</span> <span class="st">"samples"</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>table      <span class="ot">&lt;-</span> <span class="st">"natality"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="method-1-using-bq_table_download" class="level3">
<h3 class="anchored" data-anchor-id="method-1-using-bq_table_download"><strong>Method 1</strong>: Using bq_table_download</h3>
<p>In Method 1, we load data using bq_table_download in BigQuery, then perform data filtering, transformations, and joins in the local R environment.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>method1_function <span class="ot">&lt;-</span> <span class="cf">function</span>(project_id, dataset, table) {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Build the SQL query using glue</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  sql_query <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"SELECT * FROM `{project_id}.{dataset}.{table}` WHERE is_male = 1"</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Execute the query</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  query_result <span class="ot">&lt;-</span> bigrquery<span class="sc">::</span><span class="fu">bq_query</span>(sql_query)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fetch and process the data</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> bigrquery<span class="sc">::</span><span class="fu">bq_table_download</span>(query_result) <span class="sc">%&gt;%</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(result, is_male <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(result, result, <span class="at">by =</span> <span class="st">"source"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(result, <span class="at">birth_weight_kg =</span> weight_pounds <span class="sc">*</span> <span class="fl">0.453592</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>df1 <span class="ot">&lt;-</span> <span class="fu">method1_function</span>(project_id, dataset, table)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Pros</p>
<ul>
<li><p>Simplicity: This method is straightforward and easy to use, making it suitable for quick data retrieval.</p></li>
<li><p>Intuitive Data Manipulation: Data manipulation in R after downloading is more intuitive, allowing for easy filtering, joining, and transformation using familiar R functions.</p></li>
</ul>
<p>Cons</p>
<ul>
<li><p>Data Volume Limitation: May not be suitable for very large datasets as it loads the entire table into memory, potentially causing memory issues.</p></li>
<li><p>Additional Code for Transformation: Requires additional R code for filtering, joining, and transformation after downloading.</p></li>
</ul>
</section>
<section id="method-2-process-with-sql-in-bigquery" class="level3">
<h3 class="anchored" data-anchor-id="method-2-process-with-sql-in-bigquery"><strong>Method 2</strong>: Process with SQL in BigQuery</h3>
<p>Method 2 leverages the power of SQL within BigQuery to perform all data processing, including filtering, joining, and birth weight calculations, directly in the SQL query within BigQuery itself. This approach minimizes the need for additional R data manipulation.</p>
<p>Let’s create an SQL query in BigQuery that handles all the required data transformations:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the SQL query using glue to perform all data processing in BigQuery</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>sql_query <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SELECT</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="st">    t1.*,</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="st">    t2.*,</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="st">    weight_pounds * 0.453592 AS birth_weight_kg</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="st">    `{project_id}.{dataset}.{table}` AS t1</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="st">  JOIN</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="st">    `{project_id}.{dataset}.{table}` AS t2</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="st">  ON</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="st">    t1.source = t2.source</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="st">  WHERE</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="st">    t1.is_male = 1"</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Execute the query</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>query_result <span class="ot">&lt;-</span> bigrquery<span class="sc">::</span><span class="fu">bq_query</span>(sql_query)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Fetch the processed data directly from BigQuery</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> bigrquery<span class="sc">::</span><span class="fu">bq_table_download</span>(query_result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Pros</p>
<ul>
<li><p>SQL Expertise: Ideal for users with SQL expertise, as data filtering, joining, and transformation can be done entirely in SQL, leveraging the power of BigQuery.</p></li>
<li><p>Efficiency: SQL queries can be optimized for efficient data retrieval and processing within BigQuery.</p></li>
</ul>
<p>Cons</p>
<ul>
<li><p>SQL Knowledge Required: Requires proficiency in SQL for writing complex queries, which may not be suitable for all R users.</p></li>
<li><p>Potential for Complex SQL: Complex SQL queries can become difficult to manage and debug.</p></li>
</ul>
</section>
<section id="method-3-using-dbconnect-and-dbplyr" class="level3">
<h3 class="anchored" data-anchor-id="method-3-using-dbconnect-and-dbplyr"><strong>Method 3</strong>: Using dbConnect and dbplyr</h3>
<p>In Method 3, we establish a database connection and leverage dbplyr to perform data filtering, joins, and transformations directly in BigQuery. This method combines SQL and R flexibility while utilizing lazy evaluation.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>method3_function <span class="ot">&lt;-</span> <span class="cf">function</span>(project_id, dataset, table) {</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Establish a database connection</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  con <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(bigrquery<span class="sc">::</span><span class="fu">bigquery</span>(), <span class="at">project =</span> project_id, <span class="at">dataset =</span> dataset)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Query and process the data using dbplyr</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> dbplyr<span class="sc">::</span><span class="fu">tbl</span>(con, table) <span class="sc">%&gt;%</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(is_male <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(dbplyr<span class="sc">::</span><span class="fu">tbl</span>(con, table), <span class="at">by =</span> <span class="st">"source"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">birth_weight_kg =</span> weight_pounds <span class="sc">*</span> <span class="fl">0.453592</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Disconnect from the database</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  DBI<span class="sc">::</span><span class="fu">dbDisconnect</span>(con)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>df3 <span class="ot">&lt;-</span> <span class="fu">method2_function</span>(project_id, dataset, table)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Pros</p>
<ul>
<li><p>Lazy Evaluation: Utilizes lazy evaluation, allowing you to build and optimize the query step by step, enhancing query efficiency.</p></li>
<li><p>SQL and R Integration: Offers the benefits of both SQL and R, making it flexible for users with varying levels of SQL expertise.</p></li>
</ul>
<p>Cons</p>
<ul>
<li><p>Database Connection Overhead: Establishing and managing a database connection can add some overhead to the process.</p></li>
<li><p>Learning Curve: Users not familiar with dbplyr may need time to learn and adapt to this method.</p></li>
</ul>
</section>
<section id="method-4-using-materialized-view-in-bigquery" class="level3">
<h3 class="anchored" data-anchor-id="method-4-using-materialized-view-in-bigquery"><strong>Method 4</strong>: Using “Materialized View” in BigQuery</h3>
<p>Method 4 involves creating a materialized view in BigQuery that includes all data filtering, transformations, and joins. We access preprocessed data directly from the view, reducing the need for complex transformations in R.</p>
<p><strong>Create a Materialized View in BigQuery:</strong></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">MATERIALIZED</span> <span class="kw">VIEW</span> `your_project.your_dataset.your_materialized_view` <span class="kw">AS</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  column1,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  column2,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">SUM</span>(sales_amount) <span class="kw">AS</span> total_sales,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  weight_pounds <span class="op">*</span> <span class="fl">0.453592</span> <span class="kw">AS</span> birth_weight_kg</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  `your_project.your_dataset.sales_data`</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  is_male <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  column1, column2, birth_weight_kg;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Accessing Data from the Materialized View</strong></p>
<p>Now, let’s load and process data using Method 4, where all data analysis is performed within the SQL query that generates the materialized view. We won’t need additional R data manipulation in this method.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>method4_function <span class="ot">&lt;-</span> <span class="cf">function</span>(project_id, dataset, table) {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Build the SQL query to directly access the materialized view</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  sql_query <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"SELECT * FROM `{project_id}.{dataset}.{table}_materialized_view`"</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Execute the query</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  query_result <span class="ot">&lt;-</span> bigrquery<span class="sc">::</span><span class="fu">bq_query</span>(sql_query)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fetch the data directly from the materialized view</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> bigrquery<span class="sc">::</span><span class="fu">bq_table_download</span>(query_result)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>df4 <span class="ot">&lt;-</span> <span class="fu">method4_function</span>(project_id, dataset, table)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Pros</strong></p>
<ul>
<li><p>Preprocessed Data: Materialized views in BigQuery store preprocessed and aggregated data, reducing the need for complex transformations in R.</p></li>
<li><p>Efficiency: Retrieving data from a materialized view is often faster than processing raw data.</p></li>
</ul>
<p><strong>Cons</strong></p>
<ul>
<li><p>Limited Flexibility: Materialized views are predefined, limiting flexibility for custom transformations or ad-hoc queries.</p></li>
<li><p>Maintenance: Materialized views require maintenance to ensure they stay up-to-date with source data changes.</p></li>
</ul>
</section>
</section>
<section id="verification" class="level2">
<h2 class="anchored" data-anchor-id="verification">Verification</h2>
<p>To ensure the correctness of our methods, we’ll verify that the data frames returned by each method are identical.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify data frame equality</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>identical_df1_df2 <span class="ot">&lt;-</span> <span class="fu">identical</span>(df1, df2)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>identical_df1_df3 <span class="ot">&lt;-</span> <span class="fu">identical</span>(df1, df3)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>identical_df1_df4 <span class="ot">&lt;-</span> <span class="fu">identical</span>(df1, df4)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>identical_df2_df3 <span class="ot">&lt;-</span> <span class="fu">identical</span>(df2, df3)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>identical_df2_df4 <span class="ot">&lt;-</span> <span class="fu">identical</span>(df2, df4)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>identical_df3_df4 <span class="ot">&lt;-</span> <span class="fu">identical</span>(df3, df4)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Display data frame equality verification</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Data Frame Equality Verification:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Method 1 and Method 2: "</span>, identical_df1_df2, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Method 1 and Method 3: "</span>, identical_df1_df3, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Method 1 and Method 4: "</span>, identical_df1_df4, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Method 2 and Method 3: "</span>, identical_df2_df3, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Method 2 and Method 4: "</span>, identical_df2_df4, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Method 3 and Method 4: "</span>, identical_df3_df4, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="benchmarking" class="level2">
<h2 class="anchored" data-anchor-id="benchmarking">Benchmarking</h2>
<p>To determine which method is most efficient, let’s benchmark each approach.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(microbenchmark)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Benchmark each method</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>benchmark_results <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Method1 =</span> <span class="fu">method1_function</span>(project_id, dataset, table),</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">Method2 =</span> <span class="fu">method2_function</span>(project_id, dataset, table),</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">Method3 =</span> <span class="fu">method3_function</span>(project_id, dataset, table),</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Method4 =</span> <span class="fu">method4_function</span>(project_id, dataset, table),</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> <span class="dv">100</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare and summarize the benchmark results</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(benchmark_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="conclusions" class="level2">
<h2 class="anchored" data-anchor-id="conclusions">Conclusions</h2>
<p>In conclusion, the choice of data handling method in BigQuery and R depends on your specific needs. If simplicity and familiarity are your priorities, Method 1 may be suitable. For those proficient in SQL, Method 2 provides efficiency. Method 3 combines SQL and R flexibility, while Method 4 excels in efficiency and preprocessed data. By understanding these methods, you can optimize your data workflows and make informed decisions, improving your data analysis projects.</p>
</section>
<section id="references-and-helpful-links" class="level2">
<h2 class="anchored" data-anchor-id="references-and-helpful-links">References and Helpful Links</h2>
<ul>
<li>Using dbConnect and dbplyr:
<ul>
<li><a href="https://cran.r-project.org/web/packages/dbplyr/vignettes/dbplyr.html">Introduction to dbplyr</a></li>
<li><a href="https://dbplyr.tidyverse.org/articles/sql-translation.html">dbplyr SQL translation</a></li>
<li><a href="https://lazyanalyst.medium.com/sql-in-r-markdown-2ceffeb7df4">SQL queries in RMD</a></li>
</ul></li>
<li>Querying BigQuery using SQL directly in rmarkdown:
<ul>
<li><a href="https://lazyanalyst.medium.com/sql-in-r-markdown-2ceffeb7df4">RMD and SQL</a></li>
</ul></li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>